const request=require("request"),http=require("http"),https=require("https"),fs=require("fs"),path=require("path"),url=require("url"),child_process=require("child_process"),progress=require("progress-stream"),AdmZip=require("adm-zip");function bytesToSize(e){if(0===e)return"0 B";sizes=["B","KB","MB","GB","TB","PB","EB","ZB","YB"];let o=Math.floor(Math.log(e)/Math.log(1024));return(e/Math.pow(1024,o)).toFixed(2)+" "+sizes[o]}module.exports.getRemoteVersion=function(e,o){let t=https.request(e,function(e){let t="";e.on("data",function(e){t+=e}),e.on("end",function(){try{let e=JSON.parse(t);o(null,e)}catch(e){console.log(e),o(e)}})});t.on("error",function(e){console.log("请求出错："),console.log(e),o(e)}),t.end()},module.exports.downloadFile=function(e,o,t){let{protocol:n,pathname:s}=url.parse(e),l=path.basename(s),r=path.join(o,l),i="https:"===n?https.request:http.request,c=0,u=0;request.get(e).on("error",function(e){console.log("出错！"),console.log(e),t(e)}).on("response",function(o){if(200!==o.statusCode)console.log("文件下载失败！原因："),console.log(o.statusCode,o.statusMessage),t({message:"文件下载失败！statusCode: "+o.statusCode,details:o.statusMessage});else{c=o.caseless.dict["content-length"],console.time("下载耗时");let n=i(e,function(e){let o=fs.createWriteStream(r,{flags:"w",mode:438,autoClose:!0});o.on("open",function(){}),o.on("error",function(e){console.log("保存文件出错："),console.log(e)}),o.on("close",function(){console.timeEnd("下载耗时"),t&&t(null,r)}),e.on("data",function(e){u+=e.length,o.write(e)}),e.on("end",function(){o.end()})});n.on("error",function(e){console.log("请求出错："),console.log(e),t(e)}),n.end()}})},module.exports.downloadPackages=function(e,o,t,n){let s=e.length,l=0,r=[];!function i(){let c=e[l];console.log("开始下载：",c);module.exports.downloadFile(c,o,function(e,o){e?t&&t():(console.log("已下载：",o),r.push(o),l===s-1?n&&n(r):(l+=1,i()))})}()},module.exports.extraZip=function(e,o,t){let n=new AdmZip(e);console.time("解压文件"),n.extractAllTo(o,!0),console.timeEnd("解压文件"),t&&t()},module.exports.replaceFile=function(e,o,t,n){let s=path.resolve(t,"../");fs.readdir(e,function(t,l){t||(console.log("待替换文件列表：",l),l.forEach(function(t,n){let l=o[t];if(l){let o=path.join(s,l,t);console.log(`替换文件：${t} -> ${o}`),fs.renameSync(path.join(e,t),o)}}),n&&n())})},module.exports.downloadPackage=function(e,o,t){let{packageName:n,pkgSize:s,downloadUri:l}=e,r=progress({time:1e3,length:s}),i=l+n,c=path.join(o,n),u=bytesToSize(s);r.on("progress",e=>{t(u,e,c)}),console.log(`开始更新source：${i}，size: ${u}`),request.get({url:i,headers:{}}).pipe(r).pipe(fs.createWriteStream(c))},module.exports.installPackage=function(e,o){let t=child_process.execFile;console.log("install exe:",e),t(e,function(e,t){o&&o(e,t)})};